<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppMall Test Frontend</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .subtitle { color: #888; margin-bottom: 20px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: #16213e;
            border: none;
            color: #eee;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .tab:hover { background: #1f4068; }
        .tab.active { background: #00d4ff; color: #000; }
        .categories {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .category {
            background: #16213e;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 120px;
        }
        .category:hover { background: #1f4068; transform: translateY(-2px); }
        .category.active { background: #00d4ff; color: #000; }
        .category img {
            width: 48px;
            height: 48px;
            display: block;
            margin: 0 auto 10px;
            border-radius: 8px;
        }
        .apps {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .app {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }
        .app:hover { background: #1f4068; transform: translateY(-3px); }
        .app-header {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .app-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background: #0f0f23;
            flex-shrink: 0;
        }
        .app-info { flex: 1; min-width: 0; }
        .app-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .app-publisher {
            color: #888;
            font-size: 13px;
        }
        .app-desc {
            color: #aaa;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .app-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .app-rating { color: #ffd700; }
        .app-price {
            background: #00d4ff;
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
        }
        .app-price:hover { background: #00b8e6; }
        .app-size { color: #888; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .error {
            background: #ff4444;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats {
            background: #16213e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
        }
        .stat-label { color: #888; font-size: 13px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #00d4ff; }
    </style>
</head>
<body>
    <h1>AppMall Test Frontend</h1>
    <p class="subtitle">Testing categories and app display from the mock server</p>

    <div class="tabs">
        <button class="tab active" onclick="loadAll()">All Apps</button>
        <button class="tab" onclick="loadFeatured()">Featured</button>
        <button class="tab" onclick="loadFree()">Free</button>
        <button class="tab" onclick="loadBestsellers()">Bestsellers</button>
    </div>

    <div id="stats" class="stats">
        <div><div class="stat-label">Total Apps</div><div class="stat-value" id="total-apps">-</div></div>
        <div><div class="stat-label">Categories</div><div class="stat-value" id="total-cats">-</div></div>
    </div>

    <h2>Categories</h2>
    <div id="categories" class="categories">
        <div class="loading">Loading categories...</div>
    </div>

    <h2 id="apps-title">All Apps</h2>
    <div id="apps" class="apps">
        <div class="loading">Loading apps...</div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let allCategories = [];

        async function fetchXml(module, params = {}) {
            const formData = new FormData();
            formData.append('module', module);
            formData.append('items', '100');  // Request up to 100 items
            for (const [k, v] of Object.entries(params)) {
                formData.append(k, v);
            }

            const response = await fetch(`${API_BASE}/appmallpipe.php`, {
                method: 'POST',
                body: formData
            });

            const text = await response.text();
            const parser = new DOMParser();
            return parser.parseFromString(text, 'text/xml');
        }

        function renderStars(rating) {
            return '★'.repeat(rating) + '☆'.repeat(5 - rating);
        }

        async function loadCategories() {
            try {
                const xml = await fetchXml('browsecategories');
                const cats = xml.querySelectorAll('category');
                allCategories = [];

                document.getElementById('total-cats').textContent = cats.length;

                let html = '';
                cats.forEach(cat => {
                    const id = cat.getAttribute('id');
                    const name = cat.querySelector('catLabel')?.textContent || id;
                    const icon = cat.querySelector('thumbnail')?.textContent || '';
                    allCategories.push({ id, name, icon });

                    html += `
                        <div class="category" onclick="loadByCategory('${id}', '${name}')">
                            <img src="${icon}" onerror="this.style.display='none'" alt="">
                            <div>${name}</div>
                        </div>
                    `;
                });

                document.getElementById('categories').innerHTML = html;
            } catch (e) {
                document.getElementById('categories').innerHTML = `<div class="error">Error loading categories: ${e.message}</div>`;
            }
        }

        async function loadApps(module, title, params = {}) {
            document.getElementById('apps-title').textContent = title;
            document.getElementById('apps').innerHTML = '<div class="loading">Loading...</div>';

            // Clear active state on category buttons
            document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));

            try {
                const xml = await fetchXml(module, params);
                const products = xml.querySelectorAll('product');
                const total = xml.querySelector('results')?.textContent || products.length;

                document.getElementById('total-apps').textContent = total;

                if (products.length === 0) {
                    document.getElementById('apps').innerHTML = '<div class="loading">No apps found</div>';
                    return;
                }

                let html = '';
                products.forEach(p => {
                    const id = p.getAttribute('id');
                    const name = p.querySelector('productName')?.textContent || 'Unknown';
                    const desc = p.querySelector('shortDescription')?.textContent || '';
                    const icon = p.querySelector('thumbnail')?.textContent || '';
                    const publisher = p.querySelector('PublisherName')?.textContent || '';
                    const price = p.querySelector('price')?.textContent || '0.00';
                    const rating = parseInt(p.querySelector('usersRating')?.textContent || '0');
                    const size = p.querySelector('downloadSize')?.textContent || '';
                    const version = p.querySelector('version')?.textContent || '';
                    const priceLabel = price === '0.00' ? 'FREE' : '$' + price;

                    html += `
                        <div class="app">
                            <div class="app-header">
                                <img class="app-icon" src="${icon}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><rect fill=%22%23333%22 width=%2264%22 height=%2264%22/><text x=%2232%22 y=%2240%22 text-anchor=%22middle%22 fill=%22%23666%22 font-size=%2224%22>?</text></svg>'" alt="">
                                <div class="app-info">
                                    <div class="app-name">${name}</div>
                                    <div class="app-publisher">${publisher}</div>
                                </div>
                            </div>
                            <div class="app-desc">${desc}</div>
                            <div class="app-meta">
                                <span class="app-rating">${renderStars(rating)}</span>
                                <span class="app-size">${size} • v${version}</span>
                                <a class="app-price" href="#" onclick="downloadApp('${id}', this); return false;">${priceLabel}</a>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('apps').innerHTML = html;
            } catch (e) {
                document.getElementById('apps').innerHTML = `<div class="error">Error loading apps: ${e.message}</div>`;
            }
        }

        function loadAll() {
            setActiveTab(0);
            loadApps('allprods', 'All Apps');
        }

        function loadFeatured() {
            setActiveTab(1);
            loadApps('fts', 'Featured Apps');
        }

        function loadFree() {
            setActiveTab(2);
            loadApps('fs', 'Free Apps');
        }

        function loadBestsellers() {
            setActiveTab(3);
            loadApps('bss', 'Bestsellers');
        }

        function loadByCategory(catId, catName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.category').forEach(c => {
                c.classList.toggle('active', c.textContent.trim() === catName);
            });
            loadApps('software_by_category', catName, { Catid: catId });
        }

        function setActiveTab(idx) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', i === idx);
            });
        }

        async function downloadApp(productId, btn) {
            const originalText = btn.textContent;
            btn.textContent = '...';
            try {
                const xml = await fetchXml('pd', { Pid: productId });
                const downloadUrl = xml.querySelector('FreeTrialURL')?.textContent ||
                                    xml.querySelector('downloadURL')?.textContent;
                if (downloadUrl) {
                    window.location.href = downloadUrl;
                } else {
                    alert('Download URL not found');
                }
            } catch (e) {
                alert('Error fetching download: ' + e.message);
            }
            btn.textContent = originalText;
        }

        // Initial load
        loadCategories();
        loadAll();
    </script>
</body>
</html>
